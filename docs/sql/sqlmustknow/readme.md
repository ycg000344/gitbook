# SQL必知必会

> 极客时间内陈旸老师的《SQL必知必会》学习笔记
>
> https://time.geekbang.org/column/intro/192

# Select 的执行顺序


```sql
SELECT ... FROM ... WHERE ... GROUP BY ... HAVING ... ORDER BY ...
```

```sql
FROM > WHERE > GROUP BY > HAVING > SELECT 的字段 > DISTINCT > ORDER BY > LIMIT
```

# 索引的概览

## 什么情况下创建索引，什么时候不需要索引？

**索引**就是帮助数据库管理系统高效获取数据的数据结构。

**索引不是万能的，在有些情况下使用索引反而会让效率变低。**

1. 在数据表中的数据行数比较少的情况下，比如不到 1000 行，是不需要创建索引的。
2. 当数据重复度大，比如高于 10% 的时候，也不需要对这个字段使用索引。

## 索引的种类有哪些？

从功能逻辑上说，索引主要有 4 种，分别是**普通索引**、**唯一索引**、**主键索引**和**全文索引**。

按照物理实现方式，索引可以分为 2 种：**聚集索引**和**非聚集索引**。我们也把非聚集索引称为二级索引或者辅助索引。

**聚集索引**可以按照主键来排序存储数据，这样在查找行的时候非常有效。举个例子，如果是一本汉语字典，我们想要查找“数”这个字，直接在书中找汉语拼音的位置即可，也就是拼音“shu”。这样找到了索引的位置，在它后面就是我们想要找的数据行。

非聚集索引又是什么呢？

在数据库系统会有单独的存储空间存放非聚集索引，这些索引项是按照顺序存储的，但索引项指向的内容是随机存储的。也就是说系统会进行两次查找，**第一次先找到索引，第二次找到索引对应的位置取出数据行**。非聚集索引不会把索引指向的内容像聚集索引一样直接放到索引的后面，而是维护单独的索引表（只维护索引，不维护索引指向的数据），为数据检索提供方便。我们还以汉语字典为例，如果想要查找“数”字，那么按照部首查找的方式，先找到“数”字的偏旁部首，然后这个目录会告诉我们“数”字存放到第多少页，我们再去指定的页码找这个字。

聚集索引与非聚集索引的原理不同，在使用上也有一些区别：
1. 聚集索引的叶子节点存储的就是我们的数据记录，非聚集索引的叶子节点存储的是数据位置。非聚集索引不会影响数据表的物理存储顺序。
2. 一个表只能有一个聚集索引，因为只能有一种排序存储的方式，但可以有多个非聚集索引，也就是多个索引目录提供数据检索。
3. 使用聚集索引的时候，数据的查询效率高，但如果对数据进行插入，删除，更新等操作，效率会比非聚集索引低。

除了业务逻辑和物理实现方式，索引还可以按照字段个数进行划分，分成**单一索引**和**联合索引**。

创建联合索引时，我们需要注意创建时的顺序问题，因为联合索引 (x, y, z) 和 (z, y, x) 在使用的时候效率可能会存在差别。

联合索引的**最左匹配原则**，也就是按照最左优先的方式进行索引的匹配。比如刚才举例的 (x, y, z)，如果查询条件是 WHERE x=1 AND y=2 AND z=3，就可以匹配上联合索引；如果查询条件是 WHERE y=2，就无法匹配上联合索引。

# 索引的原理

## 什么是 B 树

**B 树**的英文是 Balance Tree，也就是**平衡的多路搜索树**，它的高度远小于平衡二叉树的高度。在文件系统和数据库系统中的索引结构经常采用 B 树来实现。

![bshu](bshu.jpg)

B 树作为平衡的多路搜索树，它的每一个节点最多可以包括 M 个子节点，M 称为 B 树的阶。同时你能看到，每个磁盘块中包括了关键字和子节点的指针。如果一个磁盘块中包括了 x 个关键字，那么指针数就是 x+1。对于一个 100 阶的 B 树来说，如果有 3 层的话最多可以存储约 100 万的索引数据。对于大量的索引数据来说，采用 B 树的结构是非常适合的，因为树的高度要远小于二叉树的高度。

一个 M 阶的 B 树（M>2）有以下的特性：

1. 根节点的儿子数的范围是 [2,M]。
2. 每个中间节点包含 k-1 个关键字和 k 个孩子，孩子的数量 = 关键字的数量 +1，k 的取值范围为 [ceil(M/2), M]。
3. 叶子节点包括 k-1 个关键字（叶子节点没有孩子），k 的取值范围为 [ceil(M/2), M]。
4. 假设中间节点节点的关键字为：Key[1], Key[2], …, Key[k-1]，且关键字按照升序排序，即 Key[i]<Key[i+1]。此时 k-1 个关键字相当于划分了 k 个范围，也就是对应着 k 个指针，即为：P[1], P[2], …, P[k]，其中 P[1] 指向关键字小于 Key[1] 的子树，P[i] 指向关键字属于 (Key[i-1], Key[i]) 的子树，P[k] 指向关键字大于 Key[k-1] 的子树。
5. 所有叶子节点位于同一层。

上面那张图所表示的 B 树就是一棵 3 阶的 B 树。我们可以看下磁盘块 2，里面的关键字为（8，12），它有 3 个孩子 (3，5)，(9，10) 和 (13，15)，你能看到 (3，5) 小于 8，(9，10) 在 8 和 12 之间，而 (13，15) 大于 12，刚好符合刚才我们给出的特征。

## 什么是 B+ 树

**B+ 树**基于 B 树做出了改进，主流的 DBMS 都支持 B+ 树的索引方式，比如 MySQL。B+ 树和 B 树的差异在于以下几点：
1. 有 k 个孩子的节点就有 k 个关键字。也就是孩子数量 = 关键字数，而 B 树中，孩子数量 = 关键字数 +1。
2. 非叶子节点的关键字也会同时存在在子节点中，并且是在子节点中所有关键字的最大（或最小）。
3. 非叶子节点仅用于索引，不保存数据记录，跟记录有关的信息都放在叶子节点中。而 B 树中，非叶子节点既保存索引，也保存数据记录。
4. 所有关键字都在叶子节点出现，叶子节点构成一个有序链表，而且叶子节点本身按照关键字的大小从小到大顺序链接。

下图就是一棵 B+ 树，阶数为 3，根节点中的关键字 1、18、35 分别是子节点（1，8，14），（18，24，31）和（35，41，53）中的最小值。每一层父节点的关键字都会出现在下一层的子节点的关键字中，因此在叶子节点中包括了所有的关键字信息，并且每一个叶子节点都有一个指向下一个节点的指针，这样就形成了一个链表。

![b+shu](b+shu.jpg)


# 索引的使用原则

## 创建索引的规律

1. 字段的数值有唯一性的限制，比如用户名
2. 频繁作为 `WHERE` 查询条件的字段，尤其在数据表大的情况下
3. 需要经常 `GROUP BY` 和 `ORDER BY` 的列
4. `UPDATE`、`DELETE` 的 `WHERE` 条件列，一般也需要创建索引
5. `DISTINCT` 字段需要创建索引
6. 做多表  `JOIN` 连接操作时，创建索引时连接表尽量不要超过3张，对`WHERRE`条件创建索引

## 索引失效的情况

1. 如果索引进行了表达式计算，则会失效
2. 如果对索引使用函数，也会造成失效
3. 在 `WHERE` 子句中，如果在 `OR` 前的条件列进行了索引，而在 `OR` 后的条件列没有进行索引，那么索引会失效。
4. 当我们使用 `LIKE` 进行模糊查询的时候，后面不能是 %
5. 索引列与 `NULL` 或者 `NOT NULL` 进行判断的时候也会失效。
6. 我们在使用联合索引的时候要注意最左原则

# 从数据页的角度理解 B+ 树查询

## 数据库中存储结构是怎么样的

记录是按照行来存储的，但是数据库的读取并不是以行为单位，否则一次读取（一个I/O操作）只能处理一行数据，效率会非常当地。因此**在数据库中，不论读一行，还是读多行，都是将这些行所在的页进行加载。也就是说，数据库管理存储空间的基本单位是页（Page）**。

一个页中可以存储多个行记录（`ROW`），同时在数据库中，还存在着区（`Extent`）、段（`Segment`）和表空间（`Tablespace`）。行、页、区、段、表空间的关系如下图：

![relation](relation.jpg)

区（`Extent`）是比页大一级的存储结构，在`InnoDB` 引擎中，一个区会分配64个连续的页。因为 `InnoDB`中的页大小默认是`16KB`，所以一个区的大小是 `64*16KB=1M`。

段（`Segment`）由一个或多个区组成，区在文件系统是一个连续分配的空间（在`InnoDB` 中是连续的64页），不过在段中不要求区与区之间是相邻的。段是数据库中的分配单位，不同类型的数据库对象以不同的段形式存在。当我们创建数据表、索引的时候，就会相应创建对应的段，比如创建一张表时会创建一个表段，创建一个索引时会创建一个索引段。

表空间（`Tablespace`）是一个逻辑容器，表空间存储的对象是段，在一个表空间中可以有一个或多个段，但是一个段只能属于一个表空间。数据库由一个或多个表空间组成，表空间从管理上可以划分为系统表空间、用户表空间、撤销表空间、临时表空间等。

在`InnoDB`中存在两种表空间类型：共享表空间和独立表空间。

共享表空间：多张表共用一个表空间。

独立表空间：一张表对应一个表白空间，也就是数据和索引信息都会保存在自己的表空间中。

独立的表空间可以在不同的数据库之间进行迁移。

## 数据页内的结构是怎么样的

页（`Page`）按照类型划分的话，常见的有 数据页（保存B+树节点）、系统页、Undo页和事务数据页等。数据页是最常使用的页。

页的结构如图：

![page1](page1.jpg)

作用：

![page2](page2.png)